name: ìë™ í¬ìŠ¤íŒ… (Auto Publish to Discussions)

on:
  push:
    branches:
      - main
    paths:
      - '**.md'

permissions:
  contents: write
  discussions: write

jobs:
  publish-discussion:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (Checkout Code)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ ì°¾ê¸° (Find Added Files)
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: '**.md'
          json: true # ğŸ‘ˆ ì¤‘ìš”: íŒŒì¼ ì´ë¦„ì„ ì•ˆì „í•œ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥

      - name: Discussionsì— ê¸€ ë°œí–‰í•˜ê¸° (Publish Discussion Post)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. JSON í˜•ì‹ìœ¼ë¡œ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ë„ì–´ì“°ê¸° ë¬¸ì œ í•´ê²°)
            const files = ${{ steps.changed-files.outputs.added_files }};
            
            if (!files || files.length === 0) {
              console.log('ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤ (No new files).');
              return;
            }

            const fs = require('fs');

            // 2. ë¦¬í¬ì§€í† ë¦¬ ë° ì¹´í…Œê³ ë¦¬ ID ì¡°íšŒ
            const query = `query($owner:String!, $name:String!) { repository(owner:$owner, name:$name) { id discussionCategories(first:10) { nodes { id name } } } }`;
            const variables = { owner: context.repo.owner, name: context.repo.repo };
            const result = await github.graphql(query, variables);
            const repoId = result.repository.id;
            const category = result.repository.discussionCategories.nodes.find(n => n.name === 'General');
            const categoryId = category ? category.id : result.repository.discussionCategories.nodes[0].id;

            // 3. ê¸€ ë°œí–‰ ë¡œì§
            for (const file of files) {
              if (!file || file.trim() === '') continue;
              
              // íŒŒì¼ ì´ë¦„ì—ì„œ í™•ì¥ì(.md) ì œê±°
              const title = file.split('/').pop().replace('.md', '');
              let body = '';
              
              try {
                body = fs.readFileSync(file, 'utf8');
              } catch (e) {
                console.log(`âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (Skipped): ${file}`);
                continue;
              }
              
              const mutation = `mutation($repositoryId:ID!, $categoryId:ID!, $title:String!, $body:String!) { createDiscussion(input: {repositoryId: $repositoryId, categoryId: $categoryId, title: $title, body: $body}) { discussion { url } } }`;
              
              try {
                const response = await github.graphql(mutation, { repositoryId: repoId, categoryId: categoryId, title: title, body: body });
                console.log(`âœ… ë°œí–‰ ì™„ë£Œ: ${title} - ${response.createDiscussion.discussion.url}`);
              } catch (error) {
                console.log(`âŒ ë°œí–‰ ì‹¤íŒ¨ (API Error): ${error.message}`);
              }
            }
