name: ÏûêÎèô Ìè¨Ïä§ÌåÖ (Auto Publish to Discussions)

on:
  push:
    branches:
      - main
    paths:
      - '**.md'

permissions:
  contents: write
  discussions: write

jobs:
  publish-discussion:
    runs-on: ubuntu-latest
    steps:
      - name: ÏΩîÎìú Í∞ÄÏ†∏Ïò§Í∏∞ (Checkout Code)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌååÏùº Ï∞æÍ∏∞ (Find Added Files)
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: '**.md'
          json: true

      - name: DiscussionsÏóê Í∏Ä Î∞úÌñâÌïòÍ∏∞ (Publish Discussion Post)
        uses: actions/github-script@v7
        env: 
          ADDED_FILES: ${{ steps.changed-files.outputs.added_files }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. ÌôòÍ≤Ω Î≥ÄÏàò Í∞ÄÏ†∏Ïò§Í∏∞
            let rawFiles = process.env.ADDED_FILES;
            
            if (!rawFiles) {
              console.log('ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§ (No new files).');
              return;
            }

            // üëáüëáüëá [ÌïµÏã¨ ÏàòÏ†ï] Ïó≠Ïä¨ÎûòÏãú(\) Ï†úÍ±∞ (Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Î¨∏Ïûê Ï≤≠ÏÜå)
            // GitHubÍ∞Ä ["file.md"]Î•º [\"file.md\"]Î°ú Î≥¥ÎÇº ÎïåÍ∞Ä ÏûàÏñ¥ Ïù¥Î•º ÏàòÏ†ïÌï®
            rawFiles = rawFiles.replace(/\\"/g, '"');

            let files = [];
            try {
              files = JSON.parse(rawFiles);
            } catch (e) {
              console.log(`JSON ÌååÏã± ÏóêÎü¨: ${e.message}`);
              console.log(`ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞: ${rawFiles}`);
              return;
            }

            if (files.length === 0) {
              console.log('ÌååÏùº Î™©Î°ùÏù¥ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§.');
              return;
            }

            const fs = require('fs');

            // 2. Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ Î∞è Ïπ¥ÌÖåÍ≥†Î¶¨ ID Ï°∞Ìöå
            const query = `query($owner:String!, $name:String!) { repository(owner:$owner, name:$name) { id discussionCategories(first:10) { nodes { id name } } } }`;
            const variables = { owner: context.repo.owner, name: context.repo.repo };
            const result = await github.graphql(query, variables);
            const repoId = result.repository.id;
            const category = result.repository.discussionCategories.nodes.find(n => n.name === 'General');
            const categoryId = category ? category.id : result.repository.discussionCategories.nodes[0].id;

            // 3. Í∏Ä Î∞úÌñâ Î°úÏßÅ
            for (const file of files) {
              if (!file || file.trim() === '') continue;
              
              const title = file.split('/').pop().replace('.md', '');
              let body = '';
              try {
                body = fs.readFileSync(file, 'utf8');
              } catch (e) {
                console.log(`‚ùå ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®: ${file}`);
                continue;
              }
              
              const mutation = `mutation($repositoryId:ID!, $categoryId:ID!, $title:String!, $body:String!) { createDiscussion(input: {repositoryId: $repositoryId, categoryId: $categoryId, title: $title, body: $body}) { discussion { url } } }`;
              
              try {
                const response = await github.graphql(mutation, { repositoryId: repoId, categoryId: categoryId, title: title, body: body });
                console.log(`‚úÖ Î∞úÌñâ ÏôÑÎ£å: ${title} - ${response.createDiscussion.discussion.url}`);
              } catch (error) {
                console.log(`‚ùå Î∞úÌñâ Ïã§Ìå®: ${error.message}`);
              }
            }
